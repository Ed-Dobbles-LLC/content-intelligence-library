<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Intelligence Briefings</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0d1117; --surface: #161b22; --surface2: #1c2333;
  --border: rgba(255,255,255,0.08); --red: #c0392b; --red-bright: #e74c3c;
  --red-hover: #a93226; --white: #e8eaf0; --muted: #8b949e;
  --green: #2ecc71; --amber: #f39c12; --blue: #3498db;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { background: var(--bg); color: var(--white); font-family: 'Inter', sans-serif; min-height: 100vh; }
nav { background: var(--surface); border-bottom: 1px solid var(--border); padding: 0 2rem; display: flex; align-items: center; justify-content: space-between; height: 56px; }
.brand { font-family: 'Rajdhani', sans-serif; font-size: 1.2rem; font-weight: 700; letter-spacing: 0.15em; text-transform: uppercase; }
.brand span { color: var(--red-bright); }
.nav-status { display: flex; align-items: center; gap: 1rem; }
.status-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--green); }
.status-dot.offline { background: var(--red-bright); }
.status-label { font-family: 'Rajdhani', sans-serif; font-size: 0.75rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); }
.week-badge { font-family: 'Rajdhani', sans-serif; font-size: 0.72rem; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); background: var(--surface2); border: 1px solid var(--border); border-radius: 3px; padding: 3px 8px; }
.week-badge span { color: var(--amber); font-weight: 700; }
.layout { display: grid; grid-template-columns: 1fr 280px; gap: 1.5rem; max-width: 1200px; margin: 0 auto; padding: 1.5rem; }
@media (max-width: 900px) { .layout { grid-template-columns: 1fr; } .sidebar { display: none; } }
.tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 1.5rem; gap: 0; flex-wrap: wrap; }
.tab { font-family: 'Rajdhani', sans-serif; font-size: 0.85rem; font-weight: 600; letter-spacing: 0.12em; text-transform: uppercase; padding: 10px 20px; cursor: pointer; border-bottom: 2px solid transparent; color: var(--muted); background: none; border-top: none; border-left: none; border-right: none; transition: all 0.2s; }
.tab:hover { color: var(--white); }
.tab.active { color: var(--white); border-bottom-color: var(--red-bright); }
.tab-panel { display: none; }
.tab-panel.active { display: block; }
.briefings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
@media (max-width: 700px) { .briefings-grid { grid-template-columns: 1fr; } }
.briefing-card { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 1.1rem; display: flex; flex-direction: column; gap: 0.6rem; transition: border-color 0.2s; }
.briefing-card:hover { border-color: rgba(231,76,60,0.25); }
.briefing-card.playing { border-color: var(--red-bright); }
.bc-header { display: flex; align-items: flex-start; justify-content: space-between; gap: 0.5rem; }
.bc-title { font-family: 'Rajdhani', sans-serif; font-size: 1rem; font-weight: 700; line-height: 1.3; flex: 1; }
.bc-rank { font-family: 'Rajdhani', sans-serif; font-size: 0.7rem; font-weight: 700; color: var(--red-bright); background: rgba(231,76,60,0.12); border: 1px solid rgba(231,76,60,0.3); border-radius: 3px; padding: 2px 6px; white-space: nowrap; flex-shrink: 0; }
.bc-tension { font-size: 0.78rem; color: var(--muted); line-height: 1.5; }
.bc-audio { margin-top: auto; }
.bc-audio audio { width: 100%; height: 32px; }
.btn-play { width: 100%; background: var(--surface2); border: 1px solid var(--border); border-radius: 4px; color: var(--white); font-family: 'Rajdhani', sans-serif; font-size: 0.8rem; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; padding: 9px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
.btn-play:hover { border-color: var(--red-bright); background: rgba(231,76,60,0.08); }
.btn-play:disabled { opacity: 0.5; cursor: not-allowed; }
.btn-play.ready { border-color: rgba(46,204,113,0.4); color: var(--green); }
.bc-sources { font-size: 0.68rem; color: var(--muted); font-style: italic; }
.bc-status { font-size: 0.72rem; color: var(--muted); text-align: center; min-height: 1rem; }
.btn-series-sm { width: 100%; background: transparent; border: 1px solid rgba(52,152,219,0.4); border-radius: 4px; color: var(--blue); font-family: 'Rajdhani', sans-serif; font-size: 0.72rem; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; padding: 6px; cursor: pointer; transition: all 0.2s; }
.btn-series-sm:hover { background: rgba(52,152,219,0.1); }
.discover-chat { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 1rem; margin-bottom: 1.5rem; }
.discover-chat-label { font-family: 'Rajdhani', sans-serif; font-size: 0.72rem; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; color: var(--red-bright); margin-bottom: 0.5rem; }
.discover-chat-desc { font-size: 0.78rem; color: var(--muted); margin-bottom: 0.75rem; line-height: 1.5; }
.chat-input-row { display: flex; gap: 0.5rem; }
.chat-input { flex: 1; background: var(--surface2); border: 1px solid var(--border); border-radius: 4px; color: var(--white); font-family: 'Inter', sans-serif; font-size: 0.82rem; padding: 9px 12px; outline: none; transition: border-color 0.2s; }
.chat-input:focus { border-color: var(--red-bright); }
.chat-input::placeholder { color: var(--muted); }
.btn-send { border: none; border-radius: 4px; color: var(--white); font-family: 'Rajdhani', sans-serif; font-size: 0.8rem; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; padding: 9px 18px; cursor: pointer; transition: background 0.2s; white-space: nowrap; }
.btn-send.red { background: var(--red); }
.btn-send.red:hover { background: var(--red-hover); }
.btn-send.blue { background: var(--blue); }
.btn-send.blue:hover { background: #2980b9; }
.btn-send:disabled { opacity: 0.5; cursor: not-allowed; }
.chat-status { font-size: 0.75rem; color: var(--muted); margin-top: 0.5rem; min-height: 1rem; font-style: italic; }
.chat-result { margin-top: 0.75rem; background: var(--surface2); border: 1px solid rgba(231,76,60,0.3); border-radius: 4px; padding: 0.75rem; display: none; }
.chat-result-title { font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 0.95rem; margin-bottom: 0.3rem; }
.chat-result-meta { font-size: 0.75rem; color: var(--muted); }
.chat-result-audio { margin-top: 0.6rem; }
.chat-result-audio audio { width: 100%; height: 32px; }
.chat-result-sources { font-size: 0.68rem; color: var(--muted); font-style: italic; margin-top: 0.3rem; }
.discover-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
@media (max-width: 700px) { .discover-grid { grid-template-columns: 1fr; } }
.topic-card { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 1.1rem; display: flex; flex-direction: column; gap: 0.6rem; }
.topic-card:hover { border-color: rgba(255,255,255,0.12); }
.tc-header { display: flex; align-items: flex-start; justify-content: space-between; gap: 0.5rem; }
.tc-title { font-family: 'Rajdhani', sans-serif; font-size: 0.95rem; font-weight: 700; line-height: 1.3; flex: 1; }
.tc-rank { font-family: 'Rajdhani', sans-serif; font-size: 0.68rem; font-weight: 700; color: var(--muted); background: var(--surface2); border: 1px solid var(--border); border-radius: 3px; padding: 2px 6px; flex-shrink: 0; }
.tc-label { font-family: 'Rajdhani', sans-serif; font-size: 0.65rem; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--red-bright); margin-bottom: 0.2rem; }
.tc-text { font-size: 0.77rem; color: var(--muted); line-height: 1.5; }
.tc-expand { background: none; border: none; color: var(--muted); font-size: 0.72rem; cursor: pointer; padding: 0; text-align: left; font-family: 'Rajdhani', sans-serif; letter-spacing: 0.05em; text-transform: uppercase; }
.tc-expand:hover { color: var(--white); }
.tc-detail { display: none; }
.tc-detail.open { display: block; }
.tc-audio audio { width: 100%; height: 32px; margin-top: 0.3rem; }
.tc-status { font-size: 0.72rem; color: var(--muted); font-style: italic; min-height: 1rem; }
.tc-status.ok { color: var(--green); font-style: normal; font-weight: 600; }
.tc-status.err { color: var(--red-bright); font-style: normal; }
.tc-actions { display: flex; gap: 0.4rem; margin-top: auto; padding-top: 0.5rem; border-top: 1px solid var(--border); flex-wrap: wrap; }
.btn-tc { border-radius: 3px; font-family: 'Rajdhani', sans-serif; font-size: 0.72rem; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; padding: 7px; cursor: pointer; transition: all 0.2s; }
.btn-tc.preview { flex: 1; background: transparent; border: 1px solid var(--border); color: var(--muted); }
.btn-tc.preview:hover { border-color: var(--red-bright); color: var(--white); }
.btn-tc.commission { flex: 2; background: var(--red); border: none; color: var(--white); }
.btn-tc.commission:hover { background: var(--red-hover); }
.btn-tc.series { flex: 1; background: transparent; border: 1px solid rgba(52,152,219,0.5); color: var(--blue); }
.btn-tc.series:hover { background: rgba(52,152,219,0.1); }
.btn-tc.dismiss { flex: 0 0 auto; background: transparent; border: 1px solid var(--border); color: var(--muted); }
.btn-tc.dismiss:hover { color: var(--white); }
.btn-tc:disabled { opacity: 0.4; cursor: not-allowed; }
/* MODAL */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 100; display: none; align-items: center; justify-content: center; }
.modal-overlay.open { display: flex; }
.modal { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; width: 500px; max-width: 95vw; }
.modal-title { font-family: 'Rajdhani', sans-serif; font-size: 1.1rem; font-weight: 700; margin-bottom: 0.25rem; }
.modal-sub { font-size: 0.78rem; color: var(--muted); margin-bottom: 1rem; line-height: 1.5; }
.modal-label { font-size: 0.72rem; color: var(--muted); text-transform: uppercase; font-family: 'Rajdhani', sans-serif; letter-spacing: 0.08em; margin-bottom: 0.3rem; display: block; }
.modal-input { width: 100%; background: var(--surface2); border: 1px solid var(--border); border-radius: 4px; color: var(--white); font-size: 0.82rem; padding: 9px 12px; outline: none; margin-bottom: 0.75rem; }
.modal-input:focus { border-color: var(--blue); }
.ep-count-row { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
.ep-count-btn { flex: 1; background: var(--surface2); border: 1px solid var(--border); border-radius: 3px; color: var(--muted); font-family: 'Rajdhani', sans-serif; font-size: 0.8rem; font-weight: 700; padding: 8px; cursor: pointer; transition: all 0.2s; }
.ep-count-btn.selected { border-color: var(--blue); color: var(--blue); background: rgba(52,152,219,0.1); }
.modal-actions { display: flex; gap: 0.5rem; }
.btn-modal-cancel { flex: 1; background: transparent; border: 1px solid var(--border); border-radius: 4px; color: var(--muted); font-family: 'Rajdhani', sans-serif; font-size: 0.82rem; font-weight: 700; padding: 10px; cursor: pointer; }
.btn-modal-go { flex: 2; background: var(--blue); border: none; border-radius: 4px; color: var(--white); font-family: 'Rajdhani', sans-serif; font-size: 0.82rem; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; padding: 10px; cursor: pointer; }
.btn-modal-go:hover { background: #2980b9; }
.btn-modal-go:disabled { opacity: 0.5; cursor: not-allowed; }
.modal-status { font-size: 0.75rem; color: var(--muted); margin-top: 0.5rem; text-align: center; font-style: italic; min-height: 1rem; }
/* SERIES */
.series-create-bar { background: var(--surface); border: 1px solid rgba(52,152,219,0.3); border-radius: 6px; padding: 1rem; margin-bottom: 1.5rem; }
.series-create-label { font-family: 'Rajdhani', sans-serif; font-size: 0.72rem; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; color: var(--blue); margin-bottom: 0.4rem; }
.series-create-desc { font-size: 0.78rem; color: var(--muted); margin-bottom: 0.6rem; line-height: 1.5; }
.series-list { display: flex; flex-direction: column; gap: 1rem; }
.series-card { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 1.1rem; }
.series-header { display: flex; align-items: flex-start; justify-content: space-between; gap: 0.5rem; margin-bottom: 0.5rem; }
.series-title { font-family: 'Rajdhani', sans-serif; font-size: 1rem; font-weight: 700; flex: 1; }
.series-badge { font-family: 'Rajdhani', sans-serif; font-size: 0.65rem; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; border-radius: 3px; padding: 3px 8px; flex-shrink: 0; }
.series-badge.producing { background: rgba(243,156,18,0.15); border: 1px solid rgba(243,156,18,0.4); color: var(--amber); }
.series-badge.done { background: rgba(46,204,113,0.12); border: 1px solid rgba(46,204,113,0.3); color: var(--green); }
.series-badge.error { background: rgba(231,76,60,0.12); border: 1px solid rgba(231,76,60,0.3); color: var(--red-bright); }
.series-badge.outlining { background: rgba(52,152,219,0.12); border: 1px solid rgba(52,152,219,0.3); color: var(--blue); }
.series-progress { height: 4px; background: var(--surface2); border-radius: 2px; margin-bottom: 0.75rem; overflow: hidden; }
.series-progress-fill { height: 100%; background: var(--blue); border-radius: 2px; transition: width 0.5s; }
.series-ep-row { display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; padding: 0.3rem 0; border-bottom: 1px solid var(--border); }
.series-ep-row:last-child { border-bottom: none; }
.series-ep-num { font-family: 'Rajdhani', sans-serif; font-weight: 700; color: var(--muted); width: 24px; flex-shrink: 0; }
.series-ep-title { flex: 1; color: var(--white); }
.series-ep-status { font-family: 'Rajdhani', sans-serif; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; flex-shrink: 0; }
.series-ep-status.done { color: var(--green); }
.series-ep-status.running { color: var(--amber); }
.series-ep-status.queued { color: var(--muted); }
.series-ep-status.error { color: var(--red-bright); }
/* EPISODES */
.episodes-list { display: flex; flex-direction: column; gap: 0.75rem; }
.ep-item { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 1rem; }
.ep-title { font-family: 'Rajdhani', sans-serif; font-size: 1rem; font-weight: 700; margin-bottom: 0.3rem; }
.ep-meta { display: flex; gap: 0.75rem; align-items: center; margin-bottom: 0.5rem; flex-wrap: wrap; }
.ep-badge { font-family: 'Rajdhani', sans-serif; font-size: 0.65rem; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; background: var(--surface2); border: 1px solid var(--border); border-radius: 3px; padding: 2px 7px; color: var(--muted); }
.ep-date { font-size: 0.72rem; color: var(--muted); }
.ep-sources { font-size: 0.68rem; color: var(--muted); font-style: italic; margin-top: 0.3rem; }
.ep-item audio { width: 100%; height: 32px; margin-top: 0.5rem; }
.empty-state { text-align: center; padding: 3rem 1rem; color: var(--muted); font-size: 0.85rem; }
/* ADMIN */
.admin-section { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 1rem; margin-bottom: 1rem; }
.admin-title { font-family: 'Rajdhani', sans-serif; font-size: 0.72rem; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: var(--muted); margin-bottom: 0.75rem; }
.admin-desc { font-size: 0.78rem; color: var(--muted); margin-bottom: 0.6rem; line-height: 1.5; }
.admin-row { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; margin-bottom: 0.5rem; }
.admin-status { font-size: 0.75rem; color: var(--muted); font-style: italic; }
.btn-admin { background: transparent; border: 1px solid var(--border); border-radius: 3px; color: var(--muted); font-family: 'Rajdhani', sans-serif; font-size: 0.75rem; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; padding: 7px 14px; cursor: pointer; transition: all 0.2s; }
.btn-admin.danger:hover { color: var(--red-bright); border-color: var(--red-bright); }
.btn-admin.green:hover { color: var(--green); border-color: var(--green); }
.btn-admin.amber:hover { color: var(--amber); border-color: var(--amber); }
.btn-admin:hover { color: var(--white); }
.queue-list { display: flex; flex-direction: column; gap: 0.3rem; margin-top: 0.5rem; }
.queue-item { display: flex; gap: 0.5rem; align-items: center; font-size: 0.73rem; padding: 0.3rem 0.5rem; background: var(--surface2); border-radius: 3px; }
.queue-item-status { font-family: 'Rajdhani', sans-serif; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; min-width: 55px; }
.queue-item-status.running { color: var(--amber); }
.queue-item-status.queued { color: var(--muted); }
.queue-item-progress { flex: 1; color: var(--muted); font-size: 0.7rem; }
/* SIDEBAR */
.sidebar { display: flex; flex-direction: column; gap: 1rem; }
.side-card { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 1rem; }
.side-title { font-family: 'Rajdhani', sans-serif; font-size: 0.72rem; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: var(--muted); margin-bottom: 0.75rem; }
.side-row { display: flex; justify-content: space-between; align-items: center; padding: 0.3rem 0; border-bottom: 1px solid var(--border); font-size: 0.8rem; }
.side-row:last-child { border-bottom: none; }
.side-val { font-family: 'Rajdhani', sans-serif; font-weight: 700; }
.side-val.ok { color: var(--green); }
.side-val.err { color: var(--red-bright); }
.rss-url { font-size: 0.7rem; color: var(--muted); background: var(--surface2); border: 1px solid var(--border); border-radius: 4px; padding: 6px 8px; word-break: break-all; margin-bottom: 0.5rem; }
.btn-copy { width: 100%; background: transparent; border: 1px solid var(--red-bright); border-radius: 3px; color: var(--red-bright); font-family: 'Rajdhani', sans-serif; font-size: 0.75rem; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; padding: 7px; cursor: pointer; transition: all 0.2s; }
.btn-copy:hover { background: var(--red-bright); color: var(--white); }
.voice-row { display: flex; flex-direction: column; gap: 0.3rem; margin-bottom: 0.5rem; }
.voice-label { font-size: 0.7rem; color: var(--muted); text-transform: uppercase; font-family: 'Rajdhani', sans-serif; letter-spacing: 0.08em; }
select { width: 100%; background: var(--surface2); border: 1px solid var(--border); border-radius: 4px; color: var(--white); font-size: 0.78rem; padding: 5px 8px; outline: none; }
.cap-bar { background: var(--surface2); border-radius: 3px; height: 6px; overflow: hidden; margin-top: 0.3rem; }
.cap-fill { height: 100%; background: var(--red-bright); border-radius: 3px; transition: width 0.5s; }
.cap-label { font-size: 0.68rem; color: var(--muted); margin-top: 0.3rem; }
</style>
</head>
<body>

<div class="modal-overlay" id="seriesModal">
  <div class="modal">
    <div class="modal-title" id="modalTitle">Create a Series</div>
    <div class="modal-sub" id="modalSub">Generate a progressive multi-episode arc that goes deeper on this topic.</div>
    <label class="modal-label">Override with article URL or topic (optional)</label>
    <input type="text" class="modal-input" id="modalTopicInput" placeholder="Leave blank to use selected topic, or paste URL / describe a different topic...">
    <label class="modal-label">Number of Episodes</label>
    <div class="ep-count-row">
      <button class="ep-count-btn" onclick="selectEpCount(3)">3 eps<br><small>~30 min</small></button>
      <button class="ep-count-btn selected" onclick="selectEpCount(6)">6 eps<br><small>~60 min</small></button>
      <button class="ep-count-btn" onclick="selectEpCount(9)">9 eps<br><small>~90 min</small></button>
      <button class="ep-count-btn" onclick="selectEpCount(12)">12 eps<br><small>~2 hrs</small></button>
    </div>
    <div class="modal-actions">
      <button class="btn-modal-cancel" onclick="closeSeriesModal()">Cancel</button>
      <button class="btn-modal-go" id="modalGoBtn" onclick="submitSeries()">⚡ Create 6-Episode Series</button>
    </div>
    <div class="modal-status" id="modalStatus"></div>
  </div>
</div>

<nav>
  <div class="brand">INTELLIGENCE <span>BRIEFINGS</span></div>
  <div class="nav-status">
    <div id="creditWarning" style="display:none;background:rgba(243,156,18,0.15);border:1px solid rgba(243,156,18,0.4);border-radius:3px;padding:3px 10px;font-family:'Rajdhani',sans-serif;font-size:0.7rem;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;color:var(--amber);cursor:pointer" onclick="switchTab('admin')" title="Click to view details in Admin">⚠ API Credits Low</div>
    <div id="weekBadge" class="week-badge"><span id="weekCount">0</span> this week</div>
    <button onclick="rebuildFeedNav()" id="rssNavBtn" style="background:transparent;border:1px solid var(--border);border-radius:3px;color:var(--muted);font-family:'Rajdhani',sans-serif;font-size:0.7rem;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;padding:4px 10px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.color='var(--white)';this.style.borderColor='rgba(255,255,255,0.3)'" onmouseout="this.style.color='var(--muted)';this.style.borderColor='var(--border)'">↺ RSS</button>
    <div class="status-dot" id="statusDot"></div>
    <div class="status-label" id="statusLabel">CONNECTING</div>
  </div>
</nav>

<div class="layout">
  <main>
    <div class="tabs">
      <button class="tab active" onclick="switchTab('briefings')">Today's Briefings</button>
      <button class="tab" onclick="switchTab('discover')">Discover</button>
      <button class="tab" onclick="switchTab('series')">Series</button>
      <button class="tab" onclick="switchTab('episodes')">Episodes</button>
      <button class="tab" onclick="switchTab('admin')">Admin</button>
    </div>

    <div class="tab-panel active" id="tab-briefings">
      <div class="briefings-grid" id="briefingsGrid">
        <div class="empty-state" style="grid-column:1/-1">Loading today's briefings...</div>
      </div>
    </div>

    <div class="tab-panel" id="tab-discover">
      <div class="discover-chat">
        <div class="discover-chat-label">Commission a Briefing</div>
        <div class="discover-chat-desc">Describe a topic or paste an article URL. Example: <em>"How distributors are using AI"</em> or paste any article link to get a briefing on it.</div>
        <div class="chat-input-row">
          <input type="text" class="chat-input" id="chatInput" placeholder="Topic, question, or URL..." onkeydown="if(event.key==='Enter')sendChat()">
          <button class="btn-send red" id="chatSendBtn" onclick="sendChat()">Produce</button>
        </div>
        <div class="chat-status" id="chatStatus"></div>
        <div class="chat-result" id="chatResult">
          <div class="chat-result-title" id="chatResultTitle"></div>
          <div class="chat-result-meta" id="chatResultMeta"></div>
          <div class="chat-result-audio" id="chatResultAudio"></div>
          <div class="chat-result-sources" id="chatResultSources"></div>
        </div>
      </div>

      <!-- YOU MIGHT BE INTERESTED -->
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.75rem;padding-bottom:0.5rem;border-bottom:1px solid var(--border)">
        <div>
          <div style="font-family:'Rajdhani',sans-serif;font-size:0.75rem;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--amber)">You Might Be Interested</div>
          <div style="font-size:0.73rem;color:var(--muted);margin-top:0.2rem">10 ideas based on your history + trending signals. No audio yet — commission what interests you.</div>
        </div>
        <button onclick="loadSuggestions(true)" style="background:transparent;border:1px solid var(--border);border-radius:3px;color:var(--muted);font-family:'Rajdhani',sans-serif;font-size:0.7rem;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;padding:5px 10px;cursor:pointer;white-space:nowrap;flex-shrink:0" onmouseover="this.style.color='var(--white)'" onmouseout="this.style.color='var(--muted)'">↺ Refresh</button>
      </div>
      <div class="discover-grid" id="suggestionsGrid" style="margin-bottom:2rem">
        <div class="empty-state" style="grid-column:1/-1;font-size:0.78rem">Loading suggestions...</div>
      </div>

      <!-- TODAY'S TOPICS -->
      <div style="font-family:'Rajdhani',sans-serif;font-size:0.75rem;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--muted);margin-bottom:0.75rem;padding-bottom:0.5rem;border-bottom:1px solid var(--border)">Today's Editorial Topics</div>
      <div class="discover-grid" id="discoverGrid">
        <div class="empty-state" style="grid-column:1/-1">Loading topics...</div>
      </div>
    </div>

    <div class="tab-panel" id="tab-series">
      <div class="series-create-bar">
        <div class="series-create-label">Create a New Series</div>
        <div class="series-create-desc">Paste an article URL or describe a topic. The system generates a full progressive arc — each episode goes deeper. Or hit + Series on any topic card.</div>
        <div class="chat-input-row">
          <input type="text" class="chat-input" id="seriesPromptInput" placeholder="Article URL or topic description..." style="border-color:rgba(52,152,219,0.3);">
          <button class="btn-send blue" onclick="openSeriesModal(null)">+ Series</button>
        </div>
      </div>
      <div class="series-list" id="seriesList">
        <div class="empty-state">No series yet.</div>
      </div>
    </div>

    <div class="tab-panel" id="tab-episodes">
      <div class="episodes-list" id="episodesList">
        <div class="empty-state">No episodes yet.</div>
      </div>
    </div>

    <div class="tab-panel" id="tab-admin">
      <div class="admin-section">
        <div class="admin-title">Web Search Diagnostic</div>
        <div class="admin-desc">Verify that Anthropic web search is active on your account. Episodes use web search for current grounding — if this fails, episodes fall back to Claude's training data only.</div>
        <div class="admin-row">
          <button class="btn-admin" id="wsTestBtn" onclick="testWebSearch()">▶ Test Web Search</button>
          <span class="admin-status" id="wsTestStatus"></span>
        </div>
        <div id="wsTestDetail" style="font-size:0.72rem;color:var(--muted);margin-top:0.4rem;line-height:1.5"></div>
      </div>

      <div class="admin-section">
        <div class="admin-title">Engagement Signals</div>
        <div class="admin-desc">Behavioral data used to calibrate recommendations. Improves over time as you listen, preview, and dismiss.</div>
        <div class="admin-row">
          <button class="btn-admin" onclick="loadEngagementStats()">↺ Refresh</button>
        </div>
        <div id="engagementStats" style="margin-top:0.5rem;font-size:0.75rem;color:var(--muted)">Click Refresh to load.</div>
      </div>

      <div class="admin-section">
        <div class="admin-title">Queue Management</div>
        <div class="admin-row">
          <button class="btn-admin danger" onclick="clearQueue()">✕ Clear Queue</button>
          <button class="btn-admin" onclick="refreshQueue()">↺ Refresh</button>
          <span class="admin-status" id="queueStatus">—</span>
        </div>
        <div class="queue-list" id="queueList"></div>
      </div>
      <div class="admin-section">
        <div class="admin-title">RSS Feed</div>
        <div class="admin-row">
          <button class="btn-admin green" onclick="rebuildFeed(event)">↺ Rebuild Feed</button>
          <span class="admin-status" id="feedStatus"></span>
        </div>
        <div class="rss-url" id="rssUrlAdmin">https://intelligence-briefings-production.up.railway.app/feed.xml</div>
        <button class="btn-copy" onclick="copyRSS('rssUrlAdmin')">Copy Feed URL</button>
      </div>
      <div class="admin-section">
        <div class="admin-title">Nightly Trailer Queue</div>
        <div class="admin-desc">Every night at 22:00 CT, 6 high-confidence trailers are automatically queued based on your history and trending signals. Run manually below — the system won't re-run if it already ran today (unless you force it).</div>
        <div class="admin-row">
          <button class="btn-admin amber" id="nightlyBtn" onclick="triggerNightly(false)">▶ Queue Tonight's 6 Trailers</button>
          <button class="btn-admin danger" onclick="triggerNightly(true)" style="font-size:0.68rem">Force Re-run</button>
          <span class="admin-status" id="nightlyStatus"></span>
        </div>
        <div id="nightlyResults" style="margin-top:0.5rem"></div>
        <div style="margin-top:0.75rem;padding-top:0.75rem;border-top:1px solid var(--border)">
          <div style="font-size:0.72rem;color:var(--muted);margin-bottom:0.4rem;font-family:Rajdhani,sans-serif;text-transform:uppercase;letter-spacing:0.08em;font-weight:700;">Cron Setup</div>
          <div style="font-size:0.75rem;color:var(--muted);line-height:1.6;margin-bottom:0.5rem">Daily at 22:00 America/Chicago on <a href="https://cron-job.org" target="_blank" style="color:var(--blue)">cron-job.org</a>:</div>
          <div style="font-family:monospace;font-size:0.7rem;background:var(--surface2);border:1px solid var(--border);border-radius:3px;padding:6px 10px;color:var(--white);word-break:break-all" id="nightlyCronUrl">https://intelligence-briefings-production.up.railway.app/api/cron/nightly-trailers?secret=YOUR_CRON_SECRET</div>
        </div>
      </div>

      <div class="admin-section">
        <div class="admin-title">Auto-Queue from AnswerRocket</div>
        <div class="admin-desc">Pull the latest AR competitive intelligence and automatically queue one timely episode. Use this to keep your pipeline continuously fed without manual topic selection.</div>
        <div class="admin-row">
          <button class="btn-admin amber" id="autoQueueBtn" onclick="triggerAutoQueue()">⚡ Queue AR Briefing Now</button>
          <span class="admin-status" id="autoQueueStatus"></span>
        </div>
        <div style="margin-top:0.75rem;padding-top:0.75rem;border-top:1px solid var(--border)">
          <div style="font-size:0.72rem;color:var(--muted);margin-bottom:0.4rem;font-family:Rajdhani,sans-serif;text-transform:uppercase;letter-spacing:0.08em;font-weight:700;">Scheduled Cron Setup</div>
          <div style="font-size:0.75rem;color:var(--muted);line-height:1.6;margin-bottom:0.5rem">To run daily automatically: set <code style="background:var(--surface2);padding:1px 4px;border-radius:2px">CRON_SECRET</code> in Railway, then add this URL to <a href="https://cron-job.org" target="_blank" style="color:var(--blue)">cron-job.org</a> on a daily schedule:</div>
          <div style="font-family:monospace;font-size:0.7rem;background:var(--surface2);border:1px solid var(--border);border-radius:3px;padding:6px 10px;color:var(--white);word-break:break-all;margin-bottom:0.4rem" id="cronUrlDisplay">https://intelligence-briefings-production.up.railway.app/api/cron/autoqueue?secret=YOUR_CRON_SECRET</div>
          <div style="font-size:0.7rem;color:var(--muted)">Recommended: Daily at 06:00 America/Chicago, GET request</div>
        </div>
      </div>

      <div class="admin-section">
        <div class="admin-title">Public Listener</div>
        <div class="admin-desc">Shareable public episode player — no production controls. Share with colleagues or use as your thought leadership hub.</div>
        <div class="admin-row">
          <a href="/listen" target="_blank" class="btn-admin" style="text-decoration:none">↗ Open Listener</a>
          <button class="btn-admin" onclick="navigator.clipboard.writeText(window.location.origin+'/listen').then(()=>this.textContent='✓ Copied').catch(()=>{});setTimeout(()=>this.textContent='Copy Link',2000)">Copy Link</button>
        </div>
      </div>
    </div>
  </main>

  <aside class="sidebar">
    <div class="side-card">
      <div class="side-title">API Status</div>
      <div class="side-row"><span>ElevenLabs</span><span class="side-val" id="elStatus">—</span></div>
      <div class="side-row"><span>Voices</span><span class="side-val" id="voiceCount">—</span></div>
      <div class="side-row"><span>Full Episodes</span><span class="side-val" id="episodeCount">—</span></div>
    </div>
    <div class="side-card">
      <div class="side-title">Weekly Production</div>
      <div class="cap-bar"><div class="cap-fill" id="capFill" style="width:0%"></div></div>
      <div class="cap-label" id="capLabel">Loading...</div>
    </div>
    <div class="side-card">
      <div class="side-title">Voices</div>
      <div class="voice-row">
        <div class="voice-label">Alex (Host A)</div>
        <select id="voice_alex"><option>Chris - Charming, Down-to-Earth</option></select>
      </div>
      <div class="voice-row">
        <div class="voice-label">Morgan (Host B)</div>
        <select id="voice_morgan"><option>Matilda - Knowledgable, Professional</option></select>
      </div>
    </div>
    <div class="side-card">
      <div class="side-title">RSS Feed</div>
      <div class="rss-url" id="rssUrl">https://intelligence-briefings-production.up.railway.app/feed.xml</div>
      <button class="btn-copy" onclick="copyRSS('rssUrl')">Copy Feed URL</button>
    </div>
  </aside>
</div>

<script>
let allTopics = [];
let weeklyCount = 0;
const WEEKLY_CAP = 50;
let seriesModalTopic = null;
let selectedEpCount = 6;
let seriesPollers = {};

function switchTab(name) {
  const tabs = ['briefings','discover','series','episodes','admin'];
  document.querySelectorAll('.tab').forEach((t,i) => t.classList.toggle('active', tabs[i] === name));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  if (name === 'admin') { refreshQueue(); loadNightlyStatus(); }
  if (name === 'series') loadSeries();
  if (name === 'episodes') loadEpisodes();
  if (name === 'discover') { renderDiscover(); renderSuggestions(); }
}

async function rebuildFeedNav() {
  const btn = document.getElementById('rssNavBtn');
  btn.textContent = '↺ ...';
  const data = await fetch('/api/feed/rebuild', {method:'POST'}).then(r=>r.json()).catch(()=>({success:false}));
  btn.textContent = data.success ? '✓ RSS' : '⚠ RSS';
  setTimeout(() => { btn.textContent = '↺ RSS'; }, 3000);
}

async function checkCredits() {
  try {
    const data = await fetch('/api/health').then(r=>r.json());
    const warning = document.getElementById('creditWarning');
    if(data.any_warning) {
      const el = data.health.elevenlabs;
      const an = data.health.anthropic;
      let msg = '⚠ ';
      if(el.warning && el.pct_used) msg += `ElevenLabs ${el.pct_used}% used`;
      else if(el.warning) msg += 'ElevenLabs issue';
      if(an.warning) msg += (el.warning ? ' · ' : '') + 'Anthropic quota';
      warning.textContent = msg;
      warning.style.display = 'block';
    } else {
      warning.style.display = 'none';
    }
  } catch(e) {}
}

async function init() {
  // loadTopics MUST complete before loadSuggestions — suggestions excludes today's topics
  // which are only written to cache once loadTopics finishes
  await Promise.all([loadVoices(), loadTopics(), loadEpisodes(), loadSeries()]);
  checkCredits();
  loadSuggestions();  // fires after topics cache is written, so dedup works correctly
}

async function loadVoices() {
  try {
    const data = await fetch('/api/voices').then(r => r.json());
    if (data.error) {
      document.getElementById('elStatus').textContent = 'Error'; document.getElementById('elStatus').className = 'side-val err';
      document.getElementById('statusDot').className = 'status-dot offline'; document.getElementById('statusLabel').textContent = 'OFFLINE'; return;
    }
    document.getElementById('elStatus').textContent = 'Connected'; document.getElementById('elStatus').className = 'side-val ok';
    document.getElementById('voiceCount').textContent = data.voices.length;
    document.getElementById('statusDot').className = 'status-dot'; document.getElementById('statusLabel').textContent = 'LIVE';
    const selA = document.getElementById('voice_alex'), selB = document.getElementById('voice_morgan');
    selA.innerHTML = selB.innerHTML = data.voices.map(v => `<option>${v.name}</option>`).join('');
    [...selA.options].forEach(o => { if(o.text.toLowerCase().includes('chris')) selA.value = o.text; });
    [...selB.options].forEach(o => { if(o.text.toLowerCase().includes('matilda')) selB.value = o.text; });
  } catch(e) { document.getElementById('elStatus').textContent = 'Error'; document.getElementById('elStatus').className = 'side-val err'; }
}

async function loadTopics() {
  try {
    const data = await fetch('/api/topics').then(r => r.json());
    allTopics = data.topics || []; weeklyCount = data.productions_this_week || 0;
    updateCapDisplay(); renderBriefings(); renderDiscover();
  } catch(e) { document.getElementById('briefingsGrid').innerHTML = '<div class="empty-state" style="grid-column:1/-1">Could not load topics.</div>'; }
}

function updateCapDisplay() {
  document.getElementById('weekCount').textContent = weeklyCount;
  const pct = Math.min(100, (weeklyCount / WEEKLY_CAP) * 100);
  document.getElementById('capFill').style.width = pct + '%';
  document.getElementById('capLabel').textContent = `${weeklyCount} episodes produced this week`;
}

function pollJob(jobId, onProgress, onDone, onError) {
  const interval = setInterval(async () => {
    try {
      const job = await fetch('/api/job/' + jobId).then(r => r.json());
      if (job.error && !job.status) { clearInterval(interval); onError('Job not found'); return; }
      if (job.progress) onProgress(job.progress);
      if (job.status === 'done') { clearInterval(interval); onDone(job.result); }
      else if (job.status === 'error') { clearInterval(interval); onError(job.error || 'Unknown error'); }
    } catch(e) { clearInterval(interval); onError('Connection error'); }
  }, 3000);
}

function renderBriefings() {
  const grid = document.getElementById('briefingsGrid');
  if (!allTopics.length) { grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1">No briefings today.</div>'; return; }
  grid.innerHTML = allTopics.map((t, i) => `
    <div class="briefing-card" id="bc-${i}">
      <div class="bc-header"><div class="bc-title">${t.title}</div><span class="bc-rank">#${t.rank||i+1}</span></div>
      <div class="bc-tension">${t.tension}</div>
      <div class="bc-status" id="bs-${i}"></div>
      <div class="bc-audio" id="ba-${i}"></div>
      <button class="btn-play" id="bp-${i}" onclick="generateBriefing(${i})">⚡ Generate Briefing</button>
      <button class="btn-series-sm" onclick="openSeriesModal(${i})">+ Create a Series on This Topic</button>
      <div class="bc-sources" id="bsrc-${i}"></div>
    </div>`).join('');
}

async function generateBriefing(idx) {
  const topic = allTopics[idx], btn = document.getElementById('bp-'+idx), status = document.getElementById('bs-'+idx);
  const audioDiv = document.getElementById('ba-'+idx), card = document.getElementById('bc-'+idx);
  btn.disabled = true; btn.textContent = 'Queuing...'; card.classList.add('playing'); status.textContent = 'Queued...';
  try {
    const res = await fetch('/api/generate', { method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({topic_data:topic, depth:'standard', trailer:false,
        voice_alex:document.getElementById('voice_alex').value, voice_morgan:document.getElementById('voice_morgan').value}) });
    const data = await res.json();
    if (!data.success) { status.textContent='⚠ '+(data.error||'Error'); btn.disabled=false; btn.textContent='⚡ Retry'; card.classList.remove('playing'); return; }
    pollJob(data.job_id, msg => status.textContent = msg,
      result => {
        status.textContent='✓ Episode ready';
        audioDiv.innerHTML=`<audio controls src="/episodes/${result.episode.file}"></audio>`;
        btn.textContent='↺ Regenerate'; btn.disabled=false; btn.className='btn-play ready';
        if(result.sources&&result.sources.length) document.getElementById('bsrc-'+idx).textContent='Sources: '+result.sources.join(', ');
        weeklyCount++; updateCapDisplay(); loadEpisodes();
        const audioEl = audioDiv.querySelector('audio');
        if(audioEl) trackAudio(audioEl, topic.title, result.episode.id);
      }, err => { status.textContent='⚠ '+err; btn.disabled=false; btn.textContent='⚡ Retry'; card.classList.remove('playing'); });
  } catch(e) { status.textContent='⚠ Connection error'; btn.disabled=false; btn.textContent='⚡ Retry'; card.classList.remove('playing'); }
}

// ---------------------------------------------------------------------------
// ENGAGEMENT TRACKING
// ---------------------------------------------------------------------------

const _trackedMilestones = {};  // ep_id -> Set of pcts already logged

function trackAudio(audioEl, topicTitle, episodeId) {
  if (!audioEl || !topicTitle) return;
  const key = episodeId || topicTitle;
  if (!_trackedMilestones[key]) _trackedMilestones[key] = new Set();

  audioEl.addEventListener('play', () => {
    if (!_trackedMilestones[key].has('started')) {
      _trackedMilestones[key].add('started');
      logEngagement('preview_started', topicTitle, episodeId);
    }
  });

  audioEl.addEventListener('timeupdate', () => {
    if (!audioEl.duration) return;
    const pct = Math.floor((audioEl.currentTime / audioEl.duration) * 100);
    for (const milestone of [25, 50, 75]) {
      if (pct >= milestone && !_trackedMilestones[key].has(milestone)) {
        _trackedMilestones[key].add(milestone);
        logEngagement('play_pct', topicTitle, episodeId, milestone);
      }
    }
  });

  audioEl.addEventListener('ended', () => {
    if (!_trackedMilestones[key].has('complete')) {
      _trackedMilestones[key].add('complete');
      logEngagement('listen_complete', topicTitle, episodeId);
    }
  });
}

async function logEngagement(eventType, topicTitle, episodeId, pct) {
  try {
    await fetch('/api/engagement', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({event_type: eventType, topic_title: topicTitle, episode_id: episodeId || null, pct: pct || null})
    });
  } catch(e) { /* non-fatal */ }
}

function getDismissed() { try { return JSON.parse(localStorage.getItem('dismissed_topics')||'[]'); } catch(e) { return []; } }
function addDismissed(title) {
  const d=getDismissed();
  if(!d.includes(title)) d.push(title);
  localStorage.setItem('dismissed_topics', JSON.stringify(d));
  logEngagement('dismissed', title);  // log to server for recommendation model
}

// ---- DISCOVER: Suggestions ("You Might Be Interested") ----
let allSuggestions = [];

async function loadSuggestions(refresh=false) {
  const el = document.getElementById('suggestionsGrid');
  if(el) el.innerHTML = '<div class="empty-state" style="grid-column:1/-1;font-size:0.78rem">Loading suggestions...</div>';
  try {
    const url = '/api/discover/suggestions' + (refresh ? '?refresh=true' : '');
    const data = await fetch(url).then(r=>r.json());
    allSuggestions = data.suggestions || [];
    renderSuggestions();
  } catch(e) {
    if(el) el.innerHTML = '<div class="empty-state" style="grid-column:1/-1">Could not load suggestions.</div>';
  }
}

function renderSuggestions() {
  const el = document.getElementById('suggestionsGrid');
  if(!el) return;
  const dismissed = getDismissed();
  const visible = allSuggestions.filter(s => !dismissed.includes(s.title));
  if(!visible.length) { el.innerHTML = '<div class="empty-state" style="grid-column:1/-1;font-size:0.78rem">All caught up. <button onclick="loadSuggestions(true)" style="background:none;border:none;color:var(--red-bright);cursor:pointer;font-family:Rajdhani,sans-serif;font-size:0.78rem;font-weight:700;">Refresh</button></div>'; return; }
  el.innerHTML = visible.map((s,i) => {
    const freshColor = s.freshness === 'time-sensitive' ? 'var(--red-bright)' : s.freshness === 'trending' ? 'var(--amber)' : 'var(--muted)';
    return `<div class="topic-card" id="sg-${i}" style="border-left:2px solid rgba(255,255,255,0.06)">
      <div class="tc-header">
        <div class="tc-title">${s.title}</div>
        <span class="tc-rank" style="border-color:rgba(255,255,255,0.15);color:var(--muted)">#${s.rank||i+1}</span>
      </div>
      <div><div class="tc-label">Why This, Why Now</div><div class="tc-text">${s.tension}</div></div>
      <div style="font-size:0.7rem;color:${freshColor};font-family:'Rajdhani',sans-serif;letter-spacing:0.08em;text-transform:uppercase;margin-top:0.2rem">${s.freshness||'evergreen'}</div>
      ${s.confidence_rationale ? `<div class="tc-text" style="font-style:italic;font-size:0.72rem;color:rgba(139,148,158,0.7);margin-top:0.3rem">${s.confidence_rationale}</div>` : ''}
      <div class="tc-actions" style="margin-top:0.5rem">
        <button class="btn-tc commission" onclick="commissionSuggestion(${i})" id="sgcb-${i}">Commission</button>
        <button class="btn-tc series" onclick="commissionSuggestionSeries(${i})">+ Series</button>
        <button class="btn-tc dismiss" onclick="dismissSuggestion(${i})">✕</button>
      </div>
      <div class="tc-status" id="sgs-${i}"></div>
    </div>`;
  }).join('');
}

function dismissSuggestion(i) {
  const visible = allSuggestions.filter(s => !getDismissed().includes(s.title));
  if(visible[i]) addDismissed(visible[i].title);
  renderSuggestions();
}

async function commissionSuggestion(i) {
  const visible = allSuggestions.filter(s => !getDismissed().includes(s.title));
  const s = visible[i]; if(!s) return;
  const btn = document.getElementById('sgcb-'+i), status = document.getElementById('sgs-'+i);
  btn.disabled=true; btn.textContent='Queuing...'; status.textContent='Queued...';
  const topicData = {title:s.title,tension:s.tension,why_it_matters:s.why_it_matters||'',common_mistake:'',sub_questions:[],trailer_hook:''};
  try {
    const res = await fetch('/api/generate',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({topic_data:topicData,depth:'standard',trailer:false,
        voice_alex:document.getElementById('voice_alex').value,voice_morgan:document.getElementById('voice_morgan').value})});
    const data = await res.json();
    if(!data.success){btn.disabled=false;btn.textContent='Commission';status.textContent='⚠ '+(data.error||'Error');return;}
    btn.textContent='Producing...';
    pollJob(data.job_id, msg=>status.textContent=msg,
      result=>{status.textContent='✓ Ready — see Episodes';btn.textContent='✓ Done';weeklyCount++;updateCapDisplay();loadEpisodes();},
      err=>{btn.disabled=false;btn.textContent='Commission';status.textContent='⚠ '+err;});
  } catch(e){btn.disabled=false;btn.textContent='Commission';status.textContent='⚠ Connection error';}
}

function commissionSuggestionSeries(i) {
  const visible = allSuggestions.filter(s => !getDismissed().includes(s.title));
  const s = visible[i]; if(!s) return;
  const topicData = {title:s.title,tension:s.tension,why_it_matters:s.why_it_matters||'',common_mistake:'',sub_questions:[],trailer_hook:''};
  // Temporarily push to allTopics so openSeriesModal can use it
  const tempIdx = allTopics.length;
  allTopics.push(topicData);
  openSeriesModal(tempIdx);
}

// ---- DISCOVER: Core topics grid ----
function renderDiscover() {
  const dismissed = getDismissed(), visible = allTopics.filter(t => !dismissed.includes(t.title));
  const grid = document.getElementById('discoverGrid');
  if (!visible.length) { grid.innerHTML='<div class="empty-state" style="grid-column:1/-1">All reviewed. <button onclick="localStorage.removeItem(\'dismissed_topics\');renderDiscover();renderSuggestions();" style="background:none;border:none;color:var(--red-bright);cursor:pointer;font-family:Rajdhani,sans-serif;text-transform:uppercase;font-size:0.85rem;font-weight:700;">Reset</button></div>'; return; }
  grid.innerHTML = visible.map((t) => {
    // FIX: use topic title as stable identifier, not array index
    const sqHtml = t.sub_questions ? t.sub_questions.map(q=>`<li style="margin-bottom:0.3rem">${q}</li>`).join('') : '';
    const safeTitle = encodeURIComponent(t.title);
    return `<div class="topic-card" id="tc-${safeTitle}">
      <div class="tc-header"><div class="tc-title">${t.title}</div><span class="tc-rank">#${t.rank||''}</span></div>
      <div><div class="tc-label">Core Tension</div><div class="tc-text">${t.tension}</div></div>
      <div><div class="tc-label">Why It Matters</div><div class="tc-text">${t.why_it_matters}</div></div>
      <button class="tc-expand" onclick="toggleDetailByTitle('${safeTitle}')">▸ What leaders get wrong + questions</button>
      <div class="tc-detail" id="td-${safeTitle}">
        ${t.common_mistake?`<div style="margin-bottom:0.5rem"><div class="tc-label">Common Mistake</div><div class="tc-text">${t.common_mistake}</div></div>`:''}
        ${sqHtml?`<div><div class="tc-label">Discussion Questions</div><ul style="padding-left:1rem;margin-top:0.3rem;font-size:0.77rem;color:var(--muted)">${sqHtml}</ul></div>`:''}
      </div>
      <div class="tc-audio" id="ta-${safeTitle}"></div>
      <div class="tc-status" id="ts-${safeTitle}"></div>
      <div class="tc-actions">
        <button class="btn-tc preview" id="tb-${safeTitle}" onclick="previewTopicByTitle('${safeTitle}')">▶ 90s</button>
        <button class="btn-tc commission" id="cb-${safeTitle}" onclick="commissionTopicByTitle('${safeTitle}')">Commission</button>
        <button class="btn-tc series" onclick="openSeriesModalByTitle('${safeTitle}')">+ Series</button>
        <button class="btn-tc dismiss" onclick="dismissTopicByTitle('${safeTitle}')">✕</button>
      </div>
    </div>`;
  }).join('');
}

function toggleDetailByTitle(safeTitle) {
  const d=document.getElementById('td-'+safeTitle), btn=d.previousElementSibling, open=d.classList.toggle('open');
  btn.textContent=(open?'▾':'▸')+' What leaders get wrong + questions';
}
function dismissTopicByTitle(safeTitle) {
  const title = decodeURIComponent(safeTitle);
  addDismissed(title);
  renderDiscover();
}
function getTopicByTitle(safeTitle) {
  const title = decodeURIComponent(safeTitle);
  return allTopics.find(t => t.title === title);
}
function openSeriesModalByTitle(safeTitle) {
  const t = getTopicByTitle(safeTitle); if(!t) return;
  const idx = allTopics.indexOf(t);
  openSeriesModal(idx);
}

async function previewTopicByTitle(safeTitle) {
  const topic = getTopicByTitle(safeTitle); if(!topic) return;
  const btn=document.getElementById('tb-'+safeTitle), status=document.getElementById('ts-'+safeTitle);
  btn.disabled=true; btn.textContent='...'; status.textContent='Queuing...';
  try {
    const res=await fetch('/api/generate',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({topic_data:topic,trailer:true,voice_alex:document.getElementById('voice_alex').value,voice_morgan:document.getElementById('voice_morgan').value})});
    const data=await res.json();
    if(!data.success){btn.textContent='▶ 90s';btn.disabled=false;status.textContent='⚠ '+(data.error||'Error');status.className='tc-status err';return;}
    pollJob(data.job_id, msg=>status.textContent=msg,
      result=>{btn.textContent='▶ Replay';btn.disabled=false;status.textContent='';
        document.getElementById('ta-'+safeTitle).innerHTML=`<audio controls src="/episodes/${result.episode.file}" style="width:100%;height:32px;margin-top:0.3rem"></audio>`;
        const previewAudio = document.getElementById('ta-'+safeTitle).querySelector('audio');
        if(previewAudio) trackAudio(previewAudio, decodeURIComponent(safeTitle), result.episode.id);},
      err=>{btn.textContent='▶ 90s';btn.disabled=false;status.textContent='⚠ '+err;status.className='tc-status err';});
  } catch(e){btn.textContent='▶ 90s';btn.disabled=false;status.textContent='⚠ Connection error';status.className='tc-status err';}
}

async function commissionTopicByTitle(safeTitle) {
  const topic = getTopicByTitle(safeTitle); if(!topic) return;
  const btn=document.getElementById('cb-'+safeTitle),prev=document.getElementById('tb-'+safeTitle),status=document.getElementById('ts-'+safeTitle);
  btn.disabled=true;prev.disabled=true;btn.textContent='Queuing...';status.textContent='Queued...';
  try {
    const res=await fetch('/api/generate',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({topic_data:topic,depth:'standard',trailer:false,voice_alex:document.getElementById('voice_alex').value,voice_morgan:document.getElementById('voice_morgan').value})});
    const data=await res.json();
    if(!data.success){btn.disabled=false;prev.disabled=false;btn.textContent='Commission';status.textContent='⚠ '+(data.error||'Error');status.className='tc-status err';return;}
    btn.textContent='Producing...';
    pollJob(data.job_id,msg=>{status.textContent=msg;status.className='tc-status';},
      result=>{status.textContent='✓ Ready — see Episodes';status.className='tc-status ok';btn.textContent='✓ Done';btn.disabled=true;weeklyCount++;updateCapDisplay();loadEpisodes();},
      err=>{btn.disabled=false;prev.disabled=false;btn.textContent='Commission';status.textContent='⚠ '+err;status.className='tc-status err';});
  } catch(e){btn.disabled=false;prev.disabled=false;btn.textContent='Commission';status.textContent='⚠ Connection error';status.className='tc-status err';}
}

async function sendChat() {
  const input=document.getElementById('chatInput'),btn=document.getElementById('chatSendBtn');
  const statusEl=document.getElementById('chatStatus'),resultEl=document.getElementById('chatResult');
  const message=input.value.trim(); if(!message) return;
  btn.disabled=true;btn.textContent='Queuing...';statusEl.textContent='Queued...';resultEl.style.display='none';
  try {
    const res=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({message,existing_topics:allTopics,voice_alex:document.getElementById('voice_alex').value,voice_morgan:document.getElementById('voice_morgan').value})});
    const data=await res.json();
    if(!data.success){statusEl.textContent='⚠ '+(data.error||'Failed');btn.disabled=false;btn.textContent='Produce';return;}
    btn.textContent='Producing...';
    pollJob(data.job_id,msg=>statusEl.textContent=msg,
      result=>{statusEl.textContent='';resultEl.style.display='block';
        document.getElementById('chatResultTitle').textContent=result.topic.title;
        document.getElementById('chatResultMeta').textContent=result.topic.tension;
        document.getElementById('chatResultAudio').innerHTML=`<audio controls src="/episodes/${result.episode.file}" style="width:100%;height:32px"></audio>`;
        if(result.sources&&result.sources.length) document.getElementById('chatResultSources').textContent='Sources: '+result.sources.join(', ');
        input.value='';weeklyCount++;updateCapDisplay();loadEpisodes();btn.disabled=false;btn.textContent='Produce';},
      err=>{statusEl.textContent='⚠ '+err;btn.disabled=false;btn.textContent='Produce';});
  } catch(e){statusEl.textContent='⚠ Connection error';btn.disabled=false;btn.textContent='Produce';}
}

// SERIES MODAL
function openSeriesModal(topicIdx) {
  seriesModalTopic = (topicIdx !== null && topicIdx !== undefined) ? allTopics[topicIdx] : null;
  const seriesPrompt = document.getElementById('seriesPromptInput').value.trim();
  if (seriesModalTopic) {
    document.getElementById('modalTitle').textContent = 'Create a Series';
    document.getElementById('modalSub').textContent = '"' + seriesModalTopic.title + '" — a ' + selectedEpCount + '-episode progressive arc going deeper on this topic.';
    document.getElementById('modalTopicInput').value = '';
    document.getElementById('modalTopicInput').placeholder = 'Leave blank to use this topic, or paste a URL to override';
  } else {
    document.getElementById('modalTitle').textContent = 'Create a Series from Scratch';
    document.getElementById('modalSub').textContent = 'Describe your topic or paste an article URL. The system generates a full multi-episode arc.';
    document.getElementById('modalTopicInput').value = seriesPrompt;
    document.getElementById('modalTopicInput').placeholder = 'Article URL or topic description (required)';
  }
  document.getElementById('modalStatus').textContent = '';
  document.getElementById('modalGoBtn').disabled = false;
  document.getElementById('modalGoBtn').textContent = '⚡ Create ' + selectedEpCount + '-Episode Series';
  document.getElementById('seriesModal').classList.add('open');
}
function closeSeriesModal() { document.getElementById('seriesModal').classList.remove('open'); }
function selectEpCount(n) {
  selectedEpCount = n;
  document.querySelectorAll('.ep-count-btn').forEach((btn,i) => btn.classList.toggle('selected', [3,6,9,12][i] === n));
  document.getElementById('modalGoBtn').textContent = '⚡ Create ' + n + '-Episode Series';
}

async function submitSeries() {
  const btn=document.getElementById('modalGoBtn'), statusEl=document.getElementById('modalStatus');
  const customInput=document.getElementById('modalTopicInput').value.trim();
  btn.disabled=true; statusEl.textContent='Generating series outline... (~30 sec)';
  const payload={num_episodes:selectedEpCount,voice_alex:document.getElementById('voice_alex').value,voice_morgan:document.getElementById('voice_morgan').value};
  if(customInput) payload.topic=customInput;
  else if(seriesModalTopic) payload.topic_data=seriesModalTopic;
  else { statusEl.textContent='⚠ Please enter a topic or URL.'; btn.disabled=false; return; }
  try {
    const res=await fetch('/api/series',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    const data=await res.json();
    if(!data.success){statusEl.textContent='⚠ '+(data.error||'Failed');btn.disabled=false;return;}
    statusEl.textContent='✓ Series queued! Switching to Series tab...';
    setTimeout(()=>{ closeSeriesModal(); switchTab('series'); loadSeries(); pollSeriesProgress(data.series_id); }, 1000);
  } catch(e){statusEl.textContent='⚠ Connection error';btn.disabled=false;}
}

async function loadSeries() {
  try {
    const data=await fetch('/api/series').then(r=>r.json());
    const list=data.series||[], el=document.getElementById('seriesList');
    if(!list.length){el.innerHTML='<div class="empty-state">No series yet. Create one above or from any topic card.</div>';return;}
    el.innerHTML=list.slice().reverse().map(s=>renderSeriesCard(s)).join('');
    list.filter(s=>['outlining','producing'].includes(s.status)).forEach(s=>{ if(!seriesPollers[s.id]) pollSeriesProgress(s.id); });
  } catch(e){}
}

function renderSeriesCard(s) {
  const pct=s.total?Math.round((s.completed||0)/s.total*100):0;
  const badgeMap={producing:'producing',done:'done',error:'error',outlining:'outlining',queued:'producing'};
  const labelMap={producing:'Producing',done:'Complete',error:'Error',outlining:'Building Outline',queued:'Queued'};
  const badgeClass=badgeMap[s.status]||'producing', badgeLabel=labelMap[s.status]||s.status;
  const rows=(s.job_statuses||[]).map((ep,i)=>`
    <div class="series-ep-row">
      <span class="series-ep-num">${ep.episode||i+1}</span>
      <span class="series-ep-title">${ep.title||'Episode '+(i+1)}</span>
      <span class="series-ep-status ${ep.status||'queued'}">${ep.status==='running'?(ep.progress||'Running'):ep.status||'queued'}</span>
    </div>`).join('') || (s.episodes||[]).map((ep,i)=>`
    <div class="series-ep-row">
      <span class="series-ep-num">${i+1}</span>
      <span class="series-ep-title">${ep.title||'Episode '+(i+1)}</span>
      <span class="series-ep-status queued">queued</span>
    </div>`).join('') || '<div style="font-size:0.75rem;color:var(--muted);padding:0.3rem 0">Generating outline...</div>';
  return `<div class="series-card" id="series-card-${s.id}">
    <div class="series-header">
      <div class="series-title">${s.title}</div>
      <span class="series-badge ${badgeClass}">${badgeLabel} ${s.total?`${s.completed||0}/${s.total}`:''}</span>
    </div>
    <div class="series-progress"><div class="series-progress-fill" style="width:${pct}%"></div></div>
    ${s.error?`<div style="font-size:0.75rem;color:var(--red-bright);margin-bottom:0.5rem">⚠ ${s.error}</div>`:''}
    <div>${rows}</div>
  </div>`;
}

function pollSeriesProgress(seriesId) {
  if(seriesPollers[seriesId]) return;
  const interval=setInterval(async()=>{
    try {
      const s=await fetch('/api/series/'+seriesId).then(r=>r.json());
      const card=document.getElementById('series-card-'+seriesId);
      if(card) card.outerHTML=renderSeriesCard(s);
      if(['done','error'].includes(s.status)){clearInterval(interval);delete seriesPollers[seriesId];loadEpisodes();}
    } catch(e){clearInterval(interval);delete seriesPollers[seriesId];}
  }, 5000);
  seriesPollers[seriesId]=interval;
}

async function loadEpisodes() {
  try {
    const data=await fetch('/api/episodes').then(r=>r.json());
    const full=(data.episodes||[]).filter(e=>!e.is_trailer).reverse();
    document.getElementById('episodeCount').textContent=full.length;
    const list=document.getElementById('episodesList');
    if(!full.length){list.innerHTML='<div class="empty-state">No episodes yet.</div>';return;}
    list.innerHTML=full.map(ep=>`
      <div class="ep-item" id="epitem-${ep.id}">
        <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:0.5rem">
          <div style="flex:1">
            <div class="ep-title">${ep.title}</div>
            <div class="ep-meta">
              <span class="ep-badge">${ep.depth||'Standard'}</span>
              ${ep.series_id?`<span class="ep-badge" style="border-color:rgba(52,152,219,0.3);color:#3498db">Series</span>`:''}
              <span class="ep-date">${new Date(ep.published).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}</span>
            </div>
          </div>
          <button onclick="deleteEpisode('${ep.id}', this)" style="background:transparent;border:1px solid var(--border);border-radius:3px;color:var(--muted);font-family:'Rajdhani',sans-serif;font-size:0.65rem;font-weight:700;letter-spacing:0.06em;text-transform:uppercase;padding:4px 8px;cursor:pointer;flex-shrink:0;transition:all 0.2s" onmouseover="this.style.color='var(--red-bright)';this.style.borderColor='var(--red-bright)'" onmouseout="this.style.color='var(--muted)';this.style.borderColor='var(--border)'">✕ Delete</button>
        </div>
        <audio controls src="/episodes/${ep.file}" data-ep-id="${ep.id}" data-ep-title="${ep.title.replace(/"/g,'&quot;')}"></audio>
        ${ep.sources&&ep.sources.length?`<div class="ep-sources">Sources: ${ep.sources.join(', ')}</div>`:''}
      </div>`).join('');\n    // Wire engagement tracking to all episode audio players
    list.querySelectorAll('audio[data-ep-id]').forEach(a => {
      trackAudio(a, a.dataset.epTitle, a.dataset.epId);
    });
  } catch(e){}
}

async function testWebSearch() {
  const btn=document.getElementById('wsTestBtn'), status=document.getElementById('wsTestStatus'), detail=document.getElementById('wsTestDetail');
  btn.disabled=true; status.textContent='Testing...'; detail.textContent='';
  const data = await fetch('/api/test/web-search').then(r=>r.json()).catch(()=>({success:false,error:'Connection error'}));
  btn.disabled=false;
  if(data.success) {
    status.textContent = data.web_search_invoked ? '✓ Web search active' : '⚠ Call ok, search not invoked';
    status.style.color = data.web_search_invoked ? 'var(--green)' : 'var(--amber)';
    detail.textContent = data.note || '';
  } else {
    status.textContent = '✕ Failed';
    status.style.color = 'var(--red-bright)';
    detail.textContent = (data.likely_cause || '') + (data.error ? ' — ' + data.error : '');
  }
}

async function loadEngagementStats() {
  const el = document.getElementById('engagementStats');
  el.textContent = 'Loading...';
  const data = await fetch('/api/engagement').then(r=>r.json()).catch(()=>null);
  if(!data) { el.textContent = 'Could not load.'; return; }
  const strong = data.strong_interest || [], mod = data.moderate_interest || [], dismissed = data.dismissed || [];
  if(!strong.length && !mod.length && !dismissed.length) { el.textContent = 'No engagement data yet — start listening.'; return; }
  el.innerHTML = [
    strong.length ? `<div style="margin-bottom:0.4rem"><span style="color:var(--green);font-family:Rajdhani,sans-serif;font-size:0.65rem;font-weight:700;letter-spacing:0.08em;text-transform:uppercase">Strong (75%+ listened)</span><br>${strong.map(t=>`<div style="padding:2px 0;color:var(--white)">${t}</div>`).join('')}</div>` : '',
    mod.length ? `<div style="margin-bottom:0.4rem"><span style="color:var(--amber);font-family:Rajdhani,sans-serif;font-size:0.65rem;font-weight:700;letter-spacing:0.08em;text-transform:uppercase">Moderate (previewed)</span><br>${mod.map(t=>`<div style="padding:2px 0">${t}</div>`).join('')}</div>` : '',
    dismissed.length ? `<div><span style="color:var(--muted);font-family:Rajdhani,sans-serif;font-size:0.65rem;font-weight:700;letter-spacing:0.08em;text-transform:uppercase">Dismissed</span><br>${dismissed.map(t=>`<div style="padding:2px 0">${t}</div>`).join('')}</div>` : '',
  ].filter(Boolean).join('');
}

async function deleteEpisode(epId, btn) {
  if(!confirm('Delete this episode? This cannot be undone.')) return;
  btn.textContent = '...'; btn.disabled = true;
  const data = await fetch('/api/episodes/' + epId, {method:'DELETE'})
    .then(r=>r.json()).catch(()=>({success:false,error:'Connection error'}));
  if(data.success) {
    const item = document.getElementById('epitem-' + epId);
    if(item) item.remove();
    document.getElementById('episodeCount').textContent =
      parseInt(document.getElementById('episodeCount').textContent || '1') - 1;
  } else {
    btn.textContent = '✕ Delete'; btn.disabled = false;
    alert('Delete failed: ' + (data.error || 'Unknown error'));
  }
}
  try {
    const data=await fetch('/api/queue').then(r=>r.json());
    const active=data.active||[];
    document.getElementById('queueStatus').textContent=`${active.length} active job${active.length!==1?'s':''}`;
    const list=document.getElementById('queueList');
    if(!active.length){list.innerHTML='<div style="font-size:0.75rem;color:var(--muted);padding:0.3rem 0">Queue is empty</div>';return;}
    list.innerHTML=active.map(j=>`
      <div class="queue-item">
        <span class="queue-item-status ${j.status}">${j.status}</span>
        <span class="queue-item-progress">${j.progress||'—'}</span>
        <span style="font-size:0.65rem;color:var(--muted);font-family:monospace">${j.id}</span>
      </div>`).join('');
  } catch(e){document.getElementById('queueStatus').textContent='Error';}
}

async function clearQueue() {
  if(!confirm('Clear all queued and errored jobs?')) return;
  const data=await fetch('/api/queue/clear',{method:'POST'}).then(r=>r.json()).catch(()=>({cleared:0}));
  document.getElementById('queueStatus').textContent=`Cleared ${data.cleared} job${data.cleared!==1?'s':''}`;
  await refreshQueue();
}

async function rebuildFeed(e) {
  const btn=e.target, statusEl=document.getElementById('feedStatus');
  btn.disabled=true; statusEl.textContent='Rebuilding...';
  const data=await fetch('/api/feed/rebuild',{method:'POST'}).then(r=>r.json()).catch(()=>({success:false,error:'Connection error'}));
  statusEl.textContent=data.success?`✓ ${data.episodes_in_feed} episodes in feed`:'⚠ '+data.error;
  btn.disabled=false;
}

async function triggerAutoQueue() {
  const btn=document.getElementById('autoQueueBtn'), statusEl=document.getElementById('autoQueueStatus');
  btn.disabled=true; statusEl.textContent='Fetching AR intelligence...';
  const data=await fetch('/api/autoqueue',{method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({voice_alex:document.getElementById('voice_alex').value,voice_morgan:document.getElementById('voice_morgan').value})})
    .then(r=>r.json()).catch(()=>({success:false,error:'Connection error'}));
  if(data.success){
    statusEl.textContent='✓ AR briefing queued (job '+data.job_id+')';
    pollJob(data.job_id,()=>{},()=>{statusEl.textContent='✓ AR briefing ready — check Episodes';loadEpisodes();},err=>statusEl.textContent='⚠ '+err);
  } else { statusEl.textContent='⚠ '+(data.error||'Failed'); }
  btn.disabled=false;
}

function copyRSS(elId) { navigator.clipboard.writeText(document.getElementById(elId).textContent); }

async function triggerNightly(force=false) {
  const btn=document.getElementById('nightlyBtn'), statusEl=document.getElementById('nightlyStatus'), resultsEl=document.getElementById('nightlyResults');
  btn.disabled=true; statusEl.textContent='Generating high-confidence topics...'; resultsEl.innerHTML='';
  const url = '/api/cron/nightly-trailers' + (force ? '?force=true' : '');
  const data = await fetch(url, {method:'POST'}).then(r=>r.json()).catch(()=>({success:false,error:'Connection error'}));
  btn.disabled=false;
  if(data.skipped) { statusEl.textContent='Already ran today. Use Force Re-run to override.'; return; }
  if(!data.success) { statusEl.textContent='⚠ '+(data.error||'Failed'); return; }
  statusEl.textContent=`✓ ${data.queued} trailers queued`;
  if(data.job_ids && data.job_ids.length) {
    resultsEl.innerHTML = '<div style="margin-top:0.5rem;display:flex;flex-direction:column;gap:0.25rem">' +
      data.job_ids.map(j=>`<div style="font-size:0.72rem;color:var(--muted);padding:0.25rem 0.5rem;background:var(--surface2);border-radius:3px;display:flex;justify-content:space-between">
        <span style="flex:1">${j.title}</span>
        <span style="font-family:Rajdhani,sans-serif;font-size:0.65rem;font-weight:700;color:var(--amber);margin-left:0.5rem">${j.confidence ? j.confidence+'%' : ''}</span>
      </div>`).join('') + '</div>';
  }
}

async function loadNightlyStatus() {
  try {
    const data = await fetch('/api/cron/nightly-trailers/status').then(r=>r.json());
    const run = data.run;
    if(!run) return;
    const el = document.getElementById('nightlyStatus');
    if(!el) return;
    const today = new Date().toISOString().slice(0,10);
    const ranToday = run.date === today;
    const done = (run.job_ids||[]).filter(j=>j.status==='done').length;
    const total = (run.job_ids||[]).length;
    el.textContent = ranToday ? `Last run today — ${done}/${total} trailers ready` : `Last run ${run.date}`;
  } catch(e) {}
}

init();
</script>
</body>
</html>
