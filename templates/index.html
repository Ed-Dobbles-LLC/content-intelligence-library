<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Intelligence Briefings</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0d1117; --surface: #161b22; --surface2: #1c2333;
  --border: rgba(255,255,255,0.08); --red: #c0392b; --red-bright: #e74c3c;
  --red-hover: #a93226; --white: #e8eaf0; --muted: #8b949e;
  --green: #2ecc71; --amber: #f39c12;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { background: var(--bg); color: var(--white); font-family: 'Inter', sans-serif; min-height: 100vh; }

/* NAV */
nav { background: var(--surface); border-bottom: 1px solid var(--border); padding: 0 2rem; display: flex; align-items: center; justify-content: space-between; height: 56px; }
.brand { font-family: 'Rajdhani', sans-serif; font-size: 1.2rem; font-weight: 700; letter-spacing: 0.15em; text-transform: uppercase; }
.brand span { color: var(--red-bright); }
.nav-status { display: flex; align-items: center; gap: 1rem; }
.status-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--green); }
.status-dot.offline { background: var(--red-bright); }
.status-label { font-family: 'Rajdhani', sans-serif; font-size: 0.75rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); }
.week-badge { font-family: 'Rajdhani', sans-serif; font-size: 0.72rem; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); background: var(--surface2); border: 1px solid var(--border); border-radius: 3px; padding: 3px 8px; }
.week-badge span { color: var(--amber); font-weight: 700; }

/* LAYOUT */
.layout { display: grid; grid-template-columns: 1fr 280px; gap: 1.5rem; max-width: 1200px; margin: 0 auto; padding: 1.5rem; }
@media (max-width: 900px) { .layout { grid-template-columns: 1fr; } .sidebar { display: none; } }

/* TABS */
.tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 1.5rem; gap: 0; }
.tab { font-family: 'Rajdhani', sans-serif; font-size: 0.85rem; font-weight: 600; letter-spacing: 0.12em; text-transform: uppercase; padding: 10px 20px; cursor: pointer; border-bottom: 2px solid transparent; color: var(--muted); background: none; border-top: none; border-left: none; border-right: none; transition: all 0.2s; }
.tab:hover { color: var(--white); }
.tab.active { color: var(--white); border-bottom-color: var(--red-bright); }

/* PANEL */
.tab-panel { display: none; }
.tab-panel.active { display: block; }

/* BRIEFING CARDS (Today's) */
.briefings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
@media (max-width: 700px) { .briefings-grid { grid-template-columns: 1fr; } }
.briefing-card { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 1.1rem; display: flex; flex-direction: column; gap: 0.6rem; transition: border-color 0.2s; }
.briefing-card:hover { border-color: rgba(231,76,60,0.25); }
.briefing-card.playing { border-color: var(--red-bright); }
.bc-header { display: flex; align-items: flex-start; justify-content: space-between; gap: 0.5rem; }
.bc-title { font-family: 'Rajdhani', sans-serif; font-size: 1rem; font-weight: 700; line-height: 1.3; flex: 1; }
.bc-rank { font-family: 'Rajdhani', sans-serif; font-size: 0.7rem; font-weight: 700; color: var(--red-bright); background: rgba(231,76,60,0.12); border: 1px solid rgba(231,76,60,0.3); border-radius: 3px; padding: 2px 6px; white-space: nowrap; flex-shrink: 0; }
.bc-tension { font-size: 0.78rem; color: var(--muted); line-height: 1.5; }
.bc-audio { margin-top: auto; }
.bc-audio audio { width: 100%; height: 32px; }
.bc-audio audio::-webkit-media-controls-panel { background: var(--surface2); }
.btn-play { width: 100%; background: var(--surface2); border: 1px solid var(--border); border-radius: 4px; color: var(--white); font-family: 'Rajdhani', sans-serif; font-size: 0.8rem; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; padding: 9px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
.btn-play:hover { border-color: var(--red-bright); background: rgba(231,76,60,0.08); }
.btn-play:disabled { opacity: 0.5; cursor: not-allowed; }
.btn-play.ready { border-color: rgba(46,204,113,0.4); color: var(--green); }
.bc-sources { font-size: 0.68rem; color: var(--muted); font-style: italic; margin-top: 0.2rem; }
.bc-status { font-size: 0.72rem; color: var(--muted); text-align: center; min-height: 1rem; }

/* DISCOVER */
.discover-chat { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 1rem; margin-bottom: 1.5rem; }
.discover-chat-label { font-family: 'Rajdhani', sans-serif; font-size: 0.72rem; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; color: var(--red-bright); margin-bottom: 0.5rem; }
.discover-chat-desc { font-size: 0.78rem; color: var(--muted); margin-bottom: 0.75rem; line-height: 1.5; }
.chat-input-row { display: flex; gap: 0.5rem; }
.chat-input { flex: 1; background: var(--surface2); border: 1px solid var(--border); border-radius: 4px; color: var(--white); font-family: 'Inter', sans-serif; font-size: 0.82rem; padding: 9px 12px; outline: none; transition: border-color 0.2s; }
.chat-input:focus { border-color: var(--red-bright); }
.chat-input::placeholder { color: var(--muted); }
.btn-chat-send { background: var(--red); border: none; border-radius: 4px; color: var(--white); font-family: 'Rajdhani', sans-serif; font-size: 0.8rem; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; padding: 9px 18px; cursor: pointer; transition: background 0.2s; white-space: nowrap; }
.btn-chat-send:hover { background: var(--red-hover); }
.btn-chat-send:disabled { background: #4a2020; color: var(--muted); cursor: not-allowed; }
.chat-status { font-size: 0.75rem; color: var(--muted); margin-top: 0.5rem; min-height: 1rem; font-style: italic; }
.chat-result { margin-top: 0.75rem; background: var(--surface2); border: 1px solid rgba(231,76,60,0.3); border-radius: 4px; padding: 0.75rem; display: none; }
.chat-result-title { font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 0.95rem; margin-bottom: 0.3rem; }
.chat-result-meta { font-size: 0.75rem; color: var(--muted); }
.chat-result-audio { margin-top: 0.6rem; }
.chat-result-audio audio { width: 100%; height: 32px; }
.chat-result-sources { font-size: 0.68rem; color: var(--muted); font-style: italic; margin-top: 0.3rem; }

/* DISCOVER CARDS */
.discover-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
@media (max-width: 700px) { .discover-grid { grid-template-columns: 1fr; } }
.topic-card { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 1.1rem; display: flex; flex-direction: column; gap: 0.6rem; transition: border-color 0.2s; }
.topic-card:hover { border-color: rgba(255,255,255,0.12); }
.tc-header { display: flex; align-items: flex-start; justify-content: space-between; gap: 0.5rem; }
.tc-title { font-family: 'Rajdhani', sans-serif; font-size: 0.95rem; font-weight: 700; line-height: 1.3; flex: 1; }
.tc-rank { font-family: 'Rajdhani', sans-serif; font-size: 0.68rem; font-weight: 700; color: var(--muted); background: var(--surface2); border: 1px solid var(--border); border-radius: 3px; padding: 2px 6px; flex-shrink: 0; }
.tc-label { font-family: 'Rajdhani', sans-serif; font-size: 0.65rem; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--red-bright); margin-bottom: 0.2rem; }
.tc-text { font-size: 0.77rem; color: var(--muted); line-height: 1.5; }
.tc-expand { background: none; border: none; color: var(--muted); font-size: 0.72rem; cursor: pointer; padding: 0; text-align: left; font-family: 'Rajdhani', sans-serif; letter-spacing: 0.05em; text-transform: uppercase; }
.tc-expand:hover { color: var(--white); }
.tc-detail { display: none; }
.tc-detail.open { display: block; }
.tc-audio { }
.tc-audio audio { width: 100%; height: 32px; margin-top: 0.3rem; }
.tc-status { font-size: 0.72rem; color: var(--muted); font-style: italic; min-height: 1rem; }
.tc-status.ok { color: var(--green); font-style: normal; font-weight: 600; }
.tc-status.err { color: var(--red-bright); font-style: normal; }
.tc-actions { display: flex; gap: 0.4rem; margin-top: auto; padding-top: 0.5rem; border-top: 1px solid var(--border); }
.btn-preview { flex: 1; background: transparent; border: 1px solid var(--border); border-radius: 3px; color: var(--muted); font-family: 'Rajdhani', sans-serif; font-size: 0.72rem; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; padding: 7px; cursor: pointer; transition: all 0.2s; }
.btn-preview:hover { border-color: var(--red-bright); color: var(--white); }
.btn-preview:disabled { opacity: 0.4; cursor: not-allowed; }
.btn-commission { flex: 2; background: var(--red); border: none; border-radius: 3px; color: var(--white); font-family: 'Rajdhani', sans-serif; font-size: 0.78rem; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; padding: 7px; cursor: pointer; transition: background 0.2s; }
.btn-commission:hover { background: var(--red-hover); }
.btn-commission:disabled { background: #4a2020; color: var(--muted); cursor: not-allowed; }
.btn-dismiss { flex: 0 0 auto; background: transparent; border: 1px solid var(--border); border-radius: 3px; color: var(--muted); font-family: 'Rajdhani', sans-serif; font-size: 0.72rem; padding: 7px 10px; cursor: pointer; transition: all 0.2s; }
.btn-dismiss:hover { color: var(--white); border-color: rgba(255,255,255,0.2); }

/* EPISODES */
.episodes-list { display: flex; flex-direction: column; gap: 0.75rem; }
.ep-item { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 1rem; }
.ep-title { font-family: 'Rajdhani', sans-serif; font-size: 1rem; font-weight: 700; margin-bottom: 0.3rem; }
.ep-meta { display: flex; gap: 0.75rem; align-items: center; margin-bottom: 0.5rem; flex-wrap: wrap; }
.ep-badge { font-family: 'Rajdhani', sans-serif; font-size: 0.65rem; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; background: var(--surface2); border: 1px solid var(--border); border-radius: 3px; padding: 2px 7px; color: var(--muted); }
.ep-date { font-size: 0.72rem; color: var(--muted); }
.ep-sources { font-size: 0.68rem; color: var(--muted); font-style: italic; margin-top: 0.3rem; }
.ep-item audio { width: 100%; height: 32px; margin-top: 0.5rem; }
.empty-state { text-align: center; padding: 3rem 1rem; color: var(--muted); font-size: 0.85rem; }

/* SIDEBAR */
.sidebar { display: flex; flex-direction: column; gap: 1rem; }
.side-card { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 1rem; }
.side-title { font-family: 'Rajdhani', sans-serif; font-size: 0.72rem; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: var(--muted); margin-bottom: 0.75rem; }
.side-row { display: flex; justify-content: space-between; align-items: center; padding: 0.3rem 0; border-bottom: 1px solid var(--border); font-size: 0.8rem; }
.side-row:last-child { border-bottom: none; }
.side-val { font-family: 'Rajdhani', sans-serif; font-weight: 700; }
.side-val.ok { color: var(--green); }
.side-val.err { color: var(--red-bright); }
.side-val.warn { color: var(--amber); }
.rss-url { font-size: 0.7rem; color: var(--muted); background: var(--surface2); border: 1px solid var(--border); border-radius: 4px; padding: 6px 8px; word-break: break-all; margin-bottom: 0.5rem; }
.btn-copy { width: 100%; background: transparent; border: 1px solid var(--red-bright); border-radius: 3px; color: var(--red-bright); font-family: 'Rajdhani', sans-serif; font-size: 0.75rem; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; padding: 7px; cursor: pointer; transition: all 0.2s; }
.btn-copy:hover { background: var(--red-bright); color: var(--white); }
.voice-row { display: flex; flex-direction: column; gap: 0.3rem; margin-bottom: 0.5rem; }
.voice-label { font-size: 0.7rem; color: var(--muted); text-transform: uppercase; font-family: 'Rajdhani', sans-serif; letter-spacing: 0.08em; }
select { width: 100%; background: var(--surface2); border: 1px solid var(--border); border-radius: 4px; color: var(--white); font-size: 0.78rem; padding: 5px 8px; outline: none; }
.cap-bar { background: var(--surface2); border-radius: 3px; height: 6px; overflow: hidden; margin-top: 0.3rem; }
.cap-fill { height: 100%; background: var(--red-bright); border-radius: 3px; transition: width 0.5s; }
.cap-label { font-size: 0.68rem; color: var(--muted); margin-top: 0.3rem; }
</style>
</head>
<body>

<nav>
  <div class="brand">INTELLIGENCE <span>BRIEFINGS</span></div>
  <div class="nav-status">
    <div id="weekBadge" class="week-badge"><span id="weekCount">0</span> / 5 this week</div>
    <div class="status-dot" id="statusDot"></div>
    <div class="status-label" id="statusLabel">CONNECTING</div>
  </div>
</nav>

<div class="layout">
  <main>
    <div class="tabs">
      <button class="tab active" onclick="switchTab('briefings')">Today's Briefings</button>
      <button class="tab" onclick="switchTab('discover')">Discover</button>
      <button class="tab" onclick="switchTab('episodes')">Episodes</button>
    </div>

    <!-- TODAY'S BRIEFINGS -->
    <div class="tab-panel active" id="tab-briefings">
      <div class="briefings-grid" id="briefingsGrid">
        <div class="empty-state" style="grid-column:1/-1">Loading today's briefings...</div>
      </div>
    </div>

    <!-- DISCOVER -->
    <div class="tab-panel" id="tab-discover">
      <div class="discover-chat">
        <div class="discover-chat-label">Commission a Briefing</div>
        <div class="discover-chat-desc">Tell me what you want to learn about, or reference a topic above and refine it. Example: <em>"I want to understand how distributors are using AI"</em> or <em>"Take #4 but focus on three-tier data ownership"</em></div>
        <div class="chat-input-row">
          <input type="text" class="chat-input" id="chatInput" placeholder="What do you want to explore?" onkeydown="if(event.key==='Enter')sendChat()">
          <button class="btn-chat-send" id="chatSendBtn" onclick="sendChat()">Produce →</button>
        </div>
        <div class="chat-status" id="chatStatus"></div>
        <div class="chat-result" id="chatResult">
          <div class="chat-result-title" id="chatResultTitle"></div>
          <div class="chat-result-meta" id="chatResultMeta"></div>
          <div class="chat-result-audio" id="chatResultAudio"></div>
          <div class="chat-result-sources" id="chatResultSources"></div>
        </div>
      </div>

      <div class="discover-grid" id="discoverGrid">
        <div class="empty-state" style="grid-column:1/-1">Loading topics...</div>
      </div>
    </div>

    <!-- EPISODES -->
    <div class="tab-panel" id="tab-episodes">
      <div class="episodes-list" id="episodesList">
        <div class="empty-state">No episodes yet.</div>
      </div>
    </div>
  </main>

  <aside class="sidebar">
    <div class="side-card">
      <div class="side-title">API Status</div>
      <div class="side-row"><span>ElevenLabs</span><span class="side-val" id="elStatus">—</span></div>
      <div class="side-row"><span>Voices</span><span class="side-val" id="voiceCount">—</span></div>
      <div class="side-row"><span>Full Episodes</span><span class="side-val" id="episodeCount">—</span></div>
    </div>

    <div class="side-card">
      <div class="side-title">Weekly Production</div>
      <div class="cap-bar"><div class="cap-fill" id="capFill" style="width:0%"></div></div>
      <div class="cap-label" id="capLabel">Loading...</div>
    </div>

    <div class="side-card">
      <div class="side-title">Voices</div>
      <div class="voice-row">
        <div class="voice-label">Alex (Host A)</div>
        <select id="voice_alex"><option>Chris - Charming, Down-to-Earth</option></select>
      </div>
      <div class="voice-row">
        <div class="voice-label">Morgan (Host B)</div>
        <select id="voice_morgan"><option>Matilda - Knowledgable, Professional</option></select>
      </div>
    </div>

    <div class="side-card">
      <div class="side-title">RSS Feed</div>
      <div class="rss-url" id="rssUrl">https://intelligence-briefings-production.up.railway.app/feed.xml</div>
      <button class="btn-copy" onclick="copyRSS()">Copy Feed URL</button>
    </div>
  </aside>
</div>

<script>
let allTopics = [];
let weeklyCount = 0;
const WEEKLY_CAP = 5;

function switchTab(name) {
  document.querySelectorAll('.tab').forEach((t,i) => {
    t.classList.toggle('active', ['briefings','discover','episodes'][i] === name);
  });
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
}

async function init() {
  await Promise.all([loadVoices(), loadTopics(), loadEpisodes()]);
}

async function loadVoices() {
  try {
    const data = await fetch('/api/voices').then(r => r.json());
    if (data.error) {
      document.getElementById('elStatus').textContent = 'Error';
      document.getElementById('elStatus').className = 'side-val err';
      document.getElementById('statusDot').className = 'status-dot offline';
      document.getElementById('statusLabel').textContent = 'OFFLINE';
      return;
    }
    document.getElementById('elStatus').textContent = 'Connected';
    document.getElementById('elStatus').className = 'side-val ok';
    document.getElementById('voiceCount').textContent = data.voices.length;
    document.getElementById('statusDot').className = 'status-dot';
    document.getElementById('statusLabel').textContent = 'LIVE';
    const selA = document.getElementById('voice_alex');
    const selB = document.getElementById('voice_morgan');
    selA.innerHTML = data.voices.map(v => `<option>${v.name}</option>`).join('');
    selB.innerHTML = data.voices.map(v => `<option>${v.name}</option>`).join('');
    // Try to pre-select known voices
    [...selA.options].forEach(o => { if(o.text.toLowerCase().includes('chris')) selA.value = o.text; });
    [...selB.options].forEach(o => { if(o.text.toLowerCase().includes('matilda')) selB.value = o.text; });
  } catch(e) {
    document.getElementById('elStatus').textContent = 'Error';
    document.getElementById('elStatus').className = 'side-val err';
  }
}

async function loadTopics() {
  try {
    const data = await fetch('/api/topics').then(r => r.json());
    allTopics = data.topics || [];
    weeklyCount = data.productions_this_week || 0;
    updateCapDisplay();
    renderBriefings();
    renderDiscover();
  } catch(e) {
    document.getElementById('briefingsGrid').innerHTML = '<div class="empty-state" style="grid-column:1/-1">Could not load topics.</div>';
  }
}

function updateCapDisplay() {
  document.getElementById('weekCount').textContent = weeklyCount;
  const pct = Math.min(100, (weeklyCount / WEEKLY_CAP) * 100);
  document.getElementById('capFill').style.width = pct + '%';
  document.getElementById('capFill').style.background = pct >= 100 ? 'var(--amber)' : 'var(--red-bright)';
  document.getElementById('capLabel').textContent = weeklyCount >= WEEKLY_CAP
    ? `Cap reached (${weeklyCount}/${WEEKLY_CAP}) — new week resets Sunday`
    : `${WEEKLY_CAP - weeklyCount} production${WEEKLY_CAP - weeklyCount !== 1 ? 's' : ''} remaining this week`;
}

// ---- BRIEFINGS (Today's 6, play on demand) ----
function renderBriefings() {
  const grid = document.getElementById('briefingsGrid');
  if (!allTopics.length) {
    grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1">No briefings today.</div>';
    return;
  }
  grid.innerHTML = allTopics.map((t, i) => `
    <div class="briefing-card" id="bc-${i}">
      <div class="bc-header">
        <div class="bc-title">${t.title}</div>
        <span class="bc-rank">#${t.rank || i+1}</span>
      </div>
      <div class="bc-tension">${t.tension}</div>
      <div class="bc-status" id="bs-${i}"></div>
      <div class="bc-audio" id="ba-${i}"></div>
      <button class="btn-play" id="bp-${i}" onclick="generateBriefing(${i})">⚡ Generate Briefing</button>
      <div class="bc-sources" id="bsrc-${i}"></div>
    </div>`).join('');
}

// ---- ASYNC JOB POLLER ----
// Polls /api/job/<job_id> every 3s until done or error.
// onProgress(msg): called with each progress update
// onDone(result): called with job.result when done
// onError(msg): called on error
function pollJob(jobId, onProgress, onDone, onError) {
  const interval = setInterval(async () => {
    try {
      const job = await fetch('/api/job/' + jobId).then(r => r.json());
      if (job.error && !job.status) { clearInterval(interval); onError('Job not found'); return; }
      if (job.progress) onProgress(job.progress);
      if (job.status === 'done') { clearInterval(interval); onDone(job.result); }
      else if (job.status === 'error') { clearInterval(interval); onError(job.error || 'Unknown error'); }
    } catch(e) { clearInterval(interval); onError('Connection error'); }
  }, 3000);
}

async function generateBriefing(idx) {
  const topic = allTopics[idx];
  const btn = document.getElementById('bp-' + idx);
  const status = document.getElementById('bs-' + idx);
  const audioDiv = document.getElementById('ba-' + idx);
  const card = document.getElementById('bc-' + idx);

  btn.disabled = true;
  btn.textContent = 'Generating...';
  card.classList.add('playing');
  status.textContent = 'Queuing...';

  try {
    const res = await fetch('/api/generate', {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        topic_data: topic, depth: 'standard', trailer: false,
        voice_alex: document.getElementById('voice_alex').value,
        voice_morgan: document.getElementById('voice_morgan').value
      })
    });
    const data = await res.json();
    if (!data.success) {
      status.textContent = '⚠ ' + (data.error || 'Error'); btn.disabled = false; btn.textContent = '⚡ Retry'; card.classList.remove('playing'); return;
    }
    pollJob(data.job_id,
      (msg) => { status.textContent = msg; },
      (result) => {
        status.textContent = '✓ Episode ready';
        audioDiv.innerHTML = `<audio controls src="/episodes/${result.episode.file}"></audio>`;
        btn.textContent = '↺ Regenerate'; btn.disabled = false; btn.className = 'btn-play ready';
        if (result.sources && result.sources.length)
          document.getElementById('bsrc-' + idx).textContent = 'Sources: ' + result.sources.join(', ');
        weeklyCount++; updateCapDisplay(); loadEpisodes();
      },
      (err) => {
        status.textContent = '⚠ ' + err; btn.disabled = false; btn.textContent = '⚡ Retry'; card.classList.remove('playing');
      }
    );
  } catch(e) {
    status.textContent = '⚠ Connection error'; btn.disabled = false; btn.textContent = '⚡ Retry'; card.classList.remove('playing');
  }
}

// ---- DISCOVER ----
function getDismissed() {
  try { return JSON.parse(sessionStorage.getItem('dismissed') || '[]'); } catch(e) { return []; }
}
function addDismissed(title) {
  const d = getDismissed(); d.push(title); sessionStorage.setItem('dismissed', JSON.stringify(d));
}

function renderDiscover() {
  const dismissed = getDismissed();
  const visible = allTopics.filter(t => !dismissed.includes(t.title));
  const grid = document.getElementById('discoverGrid');
  if (!visible.length) {
    grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1">All topics reviewed. <button onclick="sessionStorage.clear();renderDiscover();" style="background:none;border:none;color:var(--red-bright);cursor:pointer;font-family:Rajdhani,sans-serif;text-transform:uppercase;font-size:0.85rem;font-weight:700;letter-spacing:0.05em;">Reset</button></div>';
    return;
  }
  grid.innerHTML = visible.map((t, i) => {
    const sqHtml = t.sub_questions ? t.sub_questions.map(q => `<li style="margin-bottom:0.3rem">${q}</li>`).join('') : '';
    return `
    <div class="topic-card" id="tc-${i}">
      <div class="tc-header">
        <div class="tc-title">${t.title}</div>
        <span class="tc-rank">#${t.rank || i+1}</span>
      </div>
      <div>
        <div class="tc-label">Core Tension</div>
        <div class="tc-text">${t.tension}</div>
      </div>
      <div>
        <div class="tc-label">Why It Matters</div>
        <div class="tc-text">${t.why_it_matters}</div>
      </div>
      <button class="tc-expand" onclick="toggleDetail(${i})">▸ What leaders get wrong + questions</button>
      <div class="tc-detail" id="td-${i}">
        ${t.common_mistake ? `<div style="margin-bottom:0.5rem"><div class="tc-label">Common Mistake</div><div class="tc-text">${t.common_mistake}</div></div>` : ''}
        ${sqHtml ? `<div><div class="tc-label">Discussion Questions</div><ul style="padding-left:1rem;margin-top:0.3rem;font-size:0.77rem;color:var(--muted)">${sqHtml}</ul></div>` : ''}
      </div>
      <div class="tc-audio" id="ta-${i}"></div>
      <div class="tc-status" id="ts-${i}"></div>
      <div class="tc-actions">
        <button class="btn-preview" id="tb-${i}" onclick="previewTopic(${i})">▶ 90s Preview</button>
        <button class="btn-commission" id="cb-${i}" onclick="commissionTopic(${i})">Commission Episode</button>
        <button class="btn-dismiss" onclick="dismissTopic(${i})">✕</button>
      </div>
    </div>`;
  }).join('');
}

function toggleDetail(i) {
  const d = document.getElementById('td-' + i);
  const btn = d.previousElementSibling;
  const open = d.classList.toggle('open');
  btn.textContent = (open ? '▾' : '▸') + ' What leaders get wrong + questions';
}

function dismissTopic(idx) {
  const topic = allTopics[idx];
  if (topic) addDismissed(topic.title);
  renderDiscover();
}

async function previewTopic(idx) {
  const topic = allTopics[idx];
  if (!topic) return;
  const btn = document.getElementById('tb-' + idx);
  const status = document.getElementById('ts-' + idx);
  btn.disabled = true; btn.textContent = 'Generating...';
  status.textContent = 'Queuing preview...';
  try {
    const res = await fetch('/api/generate', {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ topic_data: topic, trailer: true,
        voice_alex: document.getElementById('voice_alex').value,
        voice_morgan: document.getElementById('voice_morgan').value })
    });
    const data = await res.json();
    if (!data.success) {
      btn.textContent = '▶ 90s Preview'; btn.disabled = false;
      status.textContent = '⚠ ' + (data.error || 'Error'); status.className = 'tc-status err'; return;
    }
    pollJob(data.job_id,
      (msg) => { status.textContent = msg; },
      (result) => {
        btn.textContent = '▶ Replay'; btn.disabled = false; status.textContent = '';
        document.getElementById('ta-' + idx).innerHTML =
          `<audio controls src="/episodes/${result.episode.file}" style="width:100%;height:32px;margin-top:0.3rem"></audio>`;
      },
      (err) => {
        btn.textContent = '▶ 90s Preview'; btn.disabled = false;
        status.textContent = '⚠ ' + err; status.className = 'tc-status err';
      }
    );
  } catch(e) { btn.textContent = '▶ 90s Preview'; btn.disabled = false; status.textContent = '⚠ Connection error'; status.className = 'tc-status err'; }
}

async function commissionTopic(idx) {
  const topic = allTopics[idx];
  if (!topic) return;
  const btn = document.getElementById('cb-' + idx);
  const prevBtn = document.getElementById('tb-' + idx);
  const status = document.getElementById('ts-' + idx);
  btn.disabled = true; prevBtn.disabled = true;
  btn.textContent = 'Queuing...';
  status.textContent = 'Queued...';
  try {
    const res = await fetch('/api/generate', {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ topic_data: topic, depth: 'standard', trailer: false,
        voice_alex: document.getElementById('voice_alex').value,
        voice_morgan: document.getElementById('voice_morgan').value })
    });
    const data = await res.json();
    if (!data.success) {
      btn.disabled = false; prevBtn.disabled = false; btn.textContent = 'Commission Episode';
      status.textContent = '⚠ ' + (data.error || 'Error'); status.className = 'tc-status err'; return;
    }
    btn.textContent = 'Producing...';
    pollJob(data.job_id,
      (msg) => { status.textContent = msg; status.className = 'tc-status'; },
      (result) => {
        status.textContent = '✓ Episode ready — see Episodes tab'; status.className = 'tc-status ok';
        btn.textContent = '✓ Commissioned'; btn.disabled = true;
        weeklyCount++; updateCapDisplay(); loadEpisodes();
      },
      (err) => {
        btn.disabled = false; prevBtn.disabled = false; btn.textContent = 'Commission Episode';
        status.textContent = '⚠ ' + err; status.className = 'tc-status err';
      }
    );
  } catch(e) {
    btn.disabled = false; prevBtn.disabled = false; btn.textContent = 'Commission Episode';
    status.textContent = '⚠ Connection error'; status.className = 'tc-status err';
  }
}

async function sendChat() {
  const input = document.getElementById('chatInput');
  const btn = document.getElementById('chatSendBtn');
  const statusEl = document.getElementById('chatStatus');
  const resultEl = document.getElementById('chatResult');
  const message = input.value.trim();
  if (!message) return;

  btn.disabled = true; btn.textContent = 'Queuing...';
  statusEl.textContent = 'Queued...';
  resultEl.style.display = 'none';

  try {
    const res = await fetch('/api/chat', {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        message, existing_topics: allTopics,
        voice_alex: document.getElementById('voice_alex').value,
        voice_morgan: document.getElementById('voice_morgan').value
      })
    });
    const data = await res.json();
    if (!data.success) {
      statusEl.textContent = '⚠ ' + (data.error || 'Production failed — try again');
      btn.disabled = false; btn.textContent = 'Produce →'; return;
    }
    btn.textContent = 'Producing...';
    pollJob(data.job_id,
      (msg) => { statusEl.textContent = msg; },
      (result) => {
        statusEl.textContent = '';
        resultEl.style.display = 'block';
        document.getElementById('chatResultTitle').textContent = result.topic.title;
        document.getElementById('chatResultMeta').textContent = result.topic.tension;
        document.getElementById('chatResultAudio').innerHTML =
          `<audio controls src="/episodes/${result.episode.file}" style="width:100%;height:32px"></audio>`;
        if (result.sources && result.sources.length)
          document.getElementById('chatResultSources').textContent = 'Sources: ' + result.sources.join(', ');
        input.value = '';
        weeklyCount++; updateCapDisplay(); loadEpisodes();
        btn.disabled = false; btn.textContent = 'Produce →';
      },
      (err) => {
        statusEl.textContent = '⚠ ' + err;
        btn.disabled = false; btn.textContent = 'Produce →';
      }
    );
  } catch(e) {
    statusEl.textContent = '⚠ Connection error';
    btn.disabled = false; btn.textContent = 'Produce →';
  }
}

// ---- EPISODES ----
async function loadEpisodes() {
  try {
    const data = await fetch('/api/episodes').then(r => r.json());
    const full = (data.episodes || []).filter(e => !e.is_trailer).reverse();
    document.getElementById('episodeCount').textContent = full.length;
    const list = document.getElementById('episodesList');
    if (!full.length) { list.innerHTML = '<div class="empty-state">No episodes yet. Play a briefing or commission from Discover.</div>'; return; }
    list.innerHTML = full.map(ep => `
      <div class="ep-item">
        <div class="ep-title">${ep.title}</div>
        <div class="ep-meta">
          <span class="ep-badge">${ep.depth || 'Standard'}</span>
          <span class="ep-date">${new Date(ep.published).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}</span>
        </div>
        <audio controls src="/episodes/${ep.file}"></audio>
        ${ep.sources && ep.sources.length ? `<div class="ep-sources">Sources: ${ep.sources.join(', ')}</div>` : ''}
      </div>`).join('');
  } catch(e) {}
}

function copyRSS() {
  navigator.clipboard.writeText(document.getElementById('rssUrl').textContent);
}

init();
</script>
</body>
</html>
